# Порядок Статусов и Действий на ТСД

## Общий Flow Процесса

```
ИМПОРТ XML
    ↓
DRAFT (Черновик)
    ↓ [confirm]
CONFIRMED (Подтверждён)
    ↓ [startReceiving]
IN_PROGRESS (Приёмка)
    ↓ [completeReceiving]
PENDING_RESOLUTION (Расхождения) / ACCEPTED (Принято)
    ↓ [resolveAndContinue / startPlacement]
PLACING (Размещение)
    ↓ [completePlacement]
STOCKED (Размещён - ФИНАЛ)
```

---

## Детальный Порядок Действий

### 1. ИМПОРТ XML → DRAFT

**Автоматически (Import Service)**

**Статус накладной**: `DRAFT`  
**Что происходит**:
- Import Service обрабатывает XML файл
- Создаётся накладная (Receipt) со статусом `DRAFT`
- Создаются строки накладной (ReceiptLine)
- Задачи (Task) еще НЕ созданы

**Действия оператора**: Нет (автоматически)

---

### 2. DRAFT → CONFIRMED (Подтверждение накладной)

**API**: `POST /api/receipts/{id}/confirm`

**Статус накладной**: `DRAFT` → `CONFIRMED`  
**Что происходит**:
- Накладная подтверждается для приёмки
- Валидация наличия строк

**Действия оператора (Desktop Client)**:
1. Открыть раздел "Поступления"
2. Найти накладную в статусе DRAFT
3. Нажать "Подтвердить"

**Статус задач**: Нет задач

---

### 3. CONFIRMED → IN_PROGRESS (Начало приёмки)

**API**: `POST /api/receipts/{id}/start-receiving`

**Статус накладной**: `CONFIRMED` → `IN_PROGRESS`  
**Что происходит**:
- Создаются задачи типа `RECEIVING` для каждой строки накладной
- Задачи получают статус `NEW`
- Накладная переходит в статус `IN_PROGRESS`

**Действия оператора (Desktop Client)**:
1. Открыть раздел "Поступления"
2. Найти накладную в статусе CONFIRMED
3. Нажать "Начать приёмку"

**Статус задач**: 
- Создаются Task со статусом `NEW`
- Тип: `RECEIVING`

---

### 4. РАБОТА НА ТСД - Приёмка Товара

#### 4.1. Назначение задачи

**API**: `POST /api/tasks/{id}/assign`  
**Параметры**: `{"assignee": "username"}`

**Статус задачи**: `NEW` → `ASSIGNED`

**Действия на ТСД**:
1. Открыть "Терминал"
2. Выбрать задачу со статусом NEW
3. Нажать "Назначить" или двойной клик

---

#### 4.2. Начало выполнения задачи

**API**: `POST /api/tasks/{id}/start`

**Статус задачи**: `ASSIGNED` → `IN_PROGRESS`

**Действия на ТСД**:
1. В карточке задачи нажать "Начать"
2. Переход на вкладку "Факт"

---

#### 4.3. Сканирование товара

**API**: `POST /api/tasks/{id}/scans`  
**Параметры**: 
```json
{
  "palletCode": "PLT-TEST-001",
  "barcode": "SKU-TEST-001",
  "qty": 50
}
```

**Статус задачи**: Остаётся `IN_PROGRESS`  
**Что происходит**:
- Создаётся запись скана (Scan)
- Проверяется соответствие товара строке задачи
- Если товар совпадает: обновляется `qtyDone` задачи
- Если товар НЕ совпадает: создаётся расхождение (Discrepancy)
- Обновляется/создаётся паллета со статусом `RECEIVING`
- Привязка паллеты к накладной и строке

**Действия на ТСД**:
1. Вкладка "Факт"
2. Поле "Паллета": ввести/сканировать код паллеты (например: PLT-TEST-001)
3. Поле "Штрих-код": сканировать товар (например: SKU-TEST-001)
4. Поле "Количество": ввести количество
5. Нажать "Записать скан" или Enter
6. Повторять шаги 2-5 для всех товаров на паллете

**Визуальная обратная связь**:
- ✅ **Зелёная вспышка** = Успешный скан
- ❌ **Красная тряска** = Ошибка (неверный товар, превышение количества)

---

#### 4.4. Завершение задачи

**API**: `POST /api/tasks/{id}/complete`

**Статус задачи**: `IN_PROGRESS` → `COMPLETED`  
**Что происходит**:
- Задача завершена
- Паллеты переводятся в статус `RECEIVED` (если всё принято)

**Действия на ТСД**:
1. После сканирования всех товаров нажать "Завершить задачу"
2. Система проверяет:
   - Все ли ожидаемое количество принято
   - Есть ли расхождения

**Примечание**: Можно завершить задачу с недобором или перебором (будет создано расхождение)

---

### 5. IN_PROGRESS → ACCEPTED или PENDING_RESOLUTION

#### 5.1. Вариант A: Завершение БЕЗ расхождений

**API**: `POST /api/receipts/{id}/complete-receiving`

**Статус накладной**: `IN_PROGRESS` → `ACCEPTED`  
**Что происходит**:
- Все задачи завершены
- Нет открытых расхождений
- Паллеты в статусе `RECEIVED`
- Накладная готова к размещению

**Действия оператора**:
1. Завершить все задачи приёмки на ТСД
2. В Desktop Client: "Поступления" → "Завершить приёмку"

---

#### 5.2. Вариант B: Завершение С расхождениями

**API**: `POST /api/receipts/{id}/complete-receiving`

**Статус накладной**: `IN_PROGRESS` → `PENDING_RESOLUTION`  
**Что происходит**:
- Обнаружены расхождения (недобор/перебор/неверный товар)
- Требуется принятие решения

**Действия оператора**:
1. Просмотреть расхождения в Desktop Client
2. Принять решение:
   - Вариант 1: Разрешить расхождения (`POST /api/discrepancies/{id}/resolve`)
   - Вариант 2: Продолжить с расхождениями (`POST /api/receipts/{id}/resolve-pending`)

**После разрешения**: `PENDING_RESOLUTION` → `ACCEPTED`

---

### 6. ACCEPTED → PLACING (Начало размещения)

**API**: `POST /api/receipts/{id}/start-placement`

**Статус накладной**: `ACCEPTED` → `PLACING`  
**Что происходит**:
- Создаются задачи типа `PLACEMENT` для каждой паллеты
- Система рассчитывает оптимальные локации (стратегия putaway)
- Задачи получают статус `NEW`

**Действия оператора**:
1. Desktop Client: "Поступления" → Найти накладную ACCEPTED
2. Нажать "Начать размещение"

**Статус задач**:
- Создаются Task типа `PLACEMENT` со статусом `NEW`

---

### 7. РАБОТА НА ТСД - Размещение Товара

#### 7.1. Назначение задачи размещения

**API**: `POST /api/tasks/{id}/assign`

**Статус задачи**: `NEW` → `ASSIGNED`

**Действия на ТСД**:
1. Терминал → Выбрать задачу PLACEMENT
2. Нажать "Назначить"

---

#### 7.2. Выполнение размещения

**API**: `POST /api/tasks/{id}/start`

**Статус задачи**: `ASSIGNED` → `IN_PROGRESS`

**Действия на ТСД**:
1. Нажать "Начать"
2. Система показывает:
   - Паллету для размещения (например: PLT-TEST-001)
   - Целевую локацию (например: A-01-02)
3. Оператор физически перемещает паллету на указанную локацию
4. Сканирует подтверждение размещения
5. Нажать "Завершить"

**Статус задачи**: `IN_PROGRESS` → `COMPLETED`  
**Статус паллеты**: `RECEIVED` → `PLACED`

---

### 8. PLACING → STOCKED (Завершение размещения)

**API**: `POST /api/receipts/{id}/complete-placement`

**Статус накладной**: `PLACING` → `STOCKED` ✅ **ФИНАЛ**  
**Что происходит**:
- Все паллеты размещены (статус `PLACED`)
- Все задачи размещения завершены
- Накладная полностью обработана

**Действия оператора**:
1. Завершить все задачи размещения на ТСД
2. Desktop Client: "Поступления" → "Завершить размещение"

---

## Сводная Таблица Статусов Накладной

| № | Статус Накладной       | Действие API                    | Кто выполняет      | Статус Задач         |
|---|------------------------|----------------------------------|--------------------|----------------------|
| 1 | `DRAFT`                | (автоматически при импорте)     | Import Service     | Нет задач            |
| 2 | `CONFIRMED`            | `POST /receipts/{id}/confirm`   | Desktop Client     | Нет задач            |
| 3 | `IN_PROGRESS`          | `POST /receipts/{id}/start-receiving` | Desktop Client | NEW → ASSIGNED → IN_PROGRESS (RECEIVING) |
| 4a| `ACCEPTED`             | `POST /receipts/{id}/complete-receiving` | Desktop Client | COMPLETED (RECEIVING) |
| 4b| `PENDING_RESOLUTION`   | `POST /receipts/{id}/complete-receiving` | Desktop Client | COMPLETED (RECEIVING) + Discrepancies |
| 5 | `PLACING`              | `POST /receipts/{id}/start-placement` | Desktop Client | NEW → ASSIGNED → IN_PROGRESS (PLACEMENT) |
| 6 | `STOCKED` ✅           | `POST /receipts/{id}/complete-placement` | Desktop Client | COMPLETED (PLACEMENT) |

---

## Сводная Таблица Статусов Задачи

| Статус       | Переход API               | Действие на ТСД                |
|--------------|---------------------------|--------------------------------|
| `NEW`        | (создаётся автоматически) | Задача доступна для назначения |
| `ASSIGNED`   | `POST /tasks/{id}/assign` | "Назначить" на себя            |
| `IN_PROGRESS`| `POST /tasks/{id}/start`  | "Начать" выполнение            |
| `COMPLETED`  | `POST /tasks/{id}/complete` | "Завершить" задачу           |
| `CANCELLED`  | `POST /tasks/{id}/release` | "Отменить" задачу             |

---

## Сценарий на ТСД (Полный Цикл)

### Фаза 1: Приёмка

```
1. Логин: testuser / password
2. Терминал → Выбрать задачу RECEIVING (статус NEW)
3. Назначить → (статус ASSIGNED)
4. Начать → (статус IN_PROGRESS)
5. Вкладка "Факт":
   a. Паллета: PLT-TEST-001
   b. Штрих-код: SKU-TEST-001 (сканировать)
   c. Количество: 50
   d. Записать скан (Enter)
   e. Повторить для всех товаров
6. Завершить задачу → (статус COMPLETED)
```

### Фаза 2: Размещение

```
1. Терминал → Выбрать задачу PLACEMENT (статус NEW)
2. Назначить → (статус ASSIGNED)
3. Начать → (статус IN_PROGRESS)
4. Система показывает:
   - Паллета: PLT-TEST-001
   - Локация: A-01-02
5. Физически переместить паллету
6. Подтвердить размещение (сканирование локации)
7. Завершить задачу → (статус COMPLETED)
```

---

## Важные Примечания

### Создание Паллет
- Паллеты создаются/обновляются автоматически при первом скане с новым `palletCode`
- Статус паллеты: `EMPTY` → `RECEIVING` → `RECEIVED` → `PLACED`

### Расхождения (Discrepancies)
Создаются когда:
- Отсканирован товар, не соответствующий строке задачи
- Количество превышает ожидаемое
- Недобор количества при завершении задачи

### Идемпотентность Импорта
- Повторный импорт файла с тем же `messageId` не создаст дубликат
- Возвращается существующая накладная (HTTP 200 вместо 201)

---

## Схема Процесса

```
┌──────────────┐
│  XML Import  │
└──────┬───────┘
       ↓
  ┌─────────┐
  │  DRAFT  │ (Импортирован)
  └────┬────┘
       ↓ [Подтвердить]
┌────────────┐
│ CONFIRMED  │ (Готов к приёмке)
└─────┬──────┘
      ↓ [Начать приёмку]
┌──────────────┐         ┌──────────────────┐
│ IN_PROGRESS  │────────>│ RECEIVING Tasks  │
└──────┬───────┘         │ (NEW→ASSIGNED→   │
       │                 │  IN_PROGRESS→    │
       │                 │  COMPLETED)      │
       │                 └────────┬─────────┘
       │                          │
       │                  ┌───────▼────────┐
       │                  │  ТСД: Сканы    │
       │                  │ - Паллета      │
       │                  │ - Штрих-код    │
       │                  │ - Количество   │
       │                  └───────┬────────┘
       ↓ [Завершить приёмку]      │
┌──────────────┐                  │
│  ACCEPTED    │◄─────────────────┘
│      или     │
│PENDING_RESOL │ (Если есть расхождения)
└──────┬───────┘
       ↓ [Начать размещение]
┌──────────────┐         ┌──────────────────┐
│   PLACING    │────────>│ PLACEMENT Tasks  │
└──────┬───────┘         │ (NEW→ASSIGNED→   │
       │                 │  IN_PROGRESS→    │
       │                 │  COMPLETED)      │
       │                 └────────┬─────────┘
       │                          │
       │                  ┌───────▼────────┐
       │                  │ ТСД: Размещение│
       │                  │ - Паллета      │
       │                  │ - Локация      │
       │                  └───────┬────────┘
       ↓ [Завершить размещение]   │
┌──────────────┐                  │
│   STOCKED    │◄─────────────────┘ ✅ ГОТОВО
└──────────────┘
```

---

**Дата создания**: Январь 2026  
**Версия**: 1.0
