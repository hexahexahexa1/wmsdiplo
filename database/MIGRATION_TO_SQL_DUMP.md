# üéØ –ü–µ—Ä–µ—Ö–æ–¥ –æ—Ç Flyway –º–∏–≥—Ä–∞—Ü–∏–π –∫ –µ–¥–∏–Ω–æ–º—É SQL –¥–∞–º–ø—É

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –°–æ–∑–¥–∞–Ω –µ–¥–∏–Ω—ã–π —Ñ–∞–π–ª —Å—Ö–µ–º—ã –ë–î
- **–§–∞–π–ª**: `database/init_schema.sql`
- **–°–æ–¥–µ—Ä–∂–∏—Ç**: –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã, –∏–Ω–¥–µ–∫—Å—ã, —Ç–∏–ø—ã, –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- **–†–∞–∑–º–µ—Ä**: ~480 —Å—Ç—Ä–æ–∫ —á–∏—Å—Ç–æ–≥–æ SQL

### 2. Flyway –æ—Ç–∫–ª—é—á–µ–Ω
- `core-api/src/main/resources/application.yml` ‚Üí `flyway.enabled: false`
- `import-service/src/main/resources/application.yml` ‚Üí `flyway.enabled: false`

### 3. –°–æ–∑–¥–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- **Windows**: `database/restore_database.bat`
- **Linux/Mac**: `database/restore_database.sh`
- **–î–µ–π—Å—Ç–≤–∏—è**: –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—É—é –ë–î ‚Üí –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é ‚Üí –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å—Ö–µ–º—É

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **database/README.md** - –ø–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–±–æ—Ç–µ —Å –ë–î
- **README.md** - –æ–±–Ω–æ–≤–ª–µ–Ω —Å –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

### 5. Git –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- `database/.gitignore` - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–º–ø—ã, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≥–ª–∞–≤–Ω—ã–µ —Ñ–∞–π–ª—ã

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–∫–∏ database/

```
database/
‚îú‚îÄ‚îÄ init_schema.sql         ‚Üê –ì–õ–ê–í–ù–´–ô —Ñ–∞–π–ª —Å—Ö–µ–º—ã (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–æ—Ç!)
‚îú‚îÄ‚îÄ restore_database.bat    ‚Üê –°–∫—Ä–∏–ø—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (Windows)
‚îú‚îÄ‚îÄ restore_database.sh     ‚Üê –°–∫—Ä–∏–ø—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (Linux/Mac)
‚îú‚îÄ‚îÄ README.md              ‚Üê –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ schema.sql             ‚Üê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–∞–º–ø (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
‚îî‚îÄ‚îÄ .gitignore             ‚Üê –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
```

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (–ø–æ—Å–ª–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞)
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å PostgreSQL
docker compose up -d postgres

# 2. –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É –ë–î
database\restore_database.bat   # Windows
./database/restore_database.sh  # Linux/Mac

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
gradle :core-api:bootRun
gradle :import-service:bootRun
gradle :desktop-client:run
```

### –°–±—Ä–æ—Å –ë–î –∫ —á–∏—Å—Ç–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
```bash
database\restore_database.bat
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î
1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `database/init_schema.sql`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `database\restore_database.bat`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –¥–∞–Ω–Ω—ã—Ö
```bash
# –¢–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ (–±–µ–∑ —Å—Ö–µ–º—ã)
docker exec wmsdipl-postgres pg_dump -U wmsdipl -d wmsdipl --data-only > database/data_backup.sql

# –ü–æ–ª–Ω—ã–π –¥–∞–º–ø (—Å—Ö–µ–º–∞ + –¥–∞–Ω–Ω—ã–µ)
docker exec wmsdipl-postgres pg_dump -U wmsdipl -d wmsdipl > database/full_backup.sql
```

## üéâ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

### ‚úÖ –ü–ª—é—Å—ã
1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –æ–¥–∏–Ω —Ñ–∞–π–ª –≤–º–µ—Å—Ç–æ 20+ –º–∏–≥—Ä–∞—Ü–∏–π
2. **–°–∫–æ—Ä–æ—Å—Ç—å** - –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞ —Å–µ–∫—É–Ω–¥—ã
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –Ω–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ø–æ—Ä—è–¥–∫–æ–º –º–∏–≥—Ä–∞—Ü–∏–π
4. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - –≤—Å—è —Å—Ö–µ–º–∞ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
5. **–ì–∏–±–∫–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –≤–Ω–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
6. **–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –º–∞–ª—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤** - –Ω–µ—Ç –∏–∑–±—ã—Ç–æ—á–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

### ‚ùå –ö–æ–≥–¥–∞ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥
- **Production** —Å –º–Ω–æ–≥–∏–º–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
- **Continuous deployment** —Å —á–∞—Å—Ç—ã–º–∏ —Ä–µ–ª–∏–∑–∞–º–∏
- **–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞** –∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –≤–µ—Ä—Å–∏—è–º —Å—Ö–µ–º—ã
- **–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏ (data migrations)

## üîÑ –í–æ–∑–≤—Ä–∞—Ç –∫ Flyway (–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è)

–ï—Å–ª–∏ –≤ –±—É–¥—É—â–µ–º —Ä–µ—à–∏—Ç–µ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–∏–≥—Ä–∞—Ü–∏—è–º:

1. –í–∫–ª—é—á–∏—Ç–µ Flyway –≤ `application.yml`:
```yaml
spring:
  flyway:
    enabled: true
```

2. –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é –∏–∑ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º—ã:
```bash
cp database/init_schema.sql core-api/src/main/resources/db/migration/V1__baseline.sql
```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –ù–ï –£–î–ê–õ–ï–ù–´
–°—Ç–∞—Ä—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤:
- `core-api/src/main/resources/db/migration/` (V1-V023)
- `import-service/src/main/resources/db/migration/` (V2)

–ù–æ –æ–Ω–∏ **–æ—Ç–∫–ª—é—á–µ–Ω—ã** –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

### schema_version —Ç–∞–±–ª–∏—Ü–∞
–¢–∞–±–ª–∏—Ü–∞ `schema_version` —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ `init_schema.sql` —Å —Ñ–∏–∫—Ç–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å—å—é:
```sql
INSERT INTO schema_version (installed_rank, version, description, ...) 
VALUES (1, '999', 'Manual schema - migrations disabled', ...);
```

–≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ø—ã—Ç–∫–∏ Flyway –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ —Å–ª—É—á–∞–π–Ω–æ –≤–∫–ª—é—á–∏—Ç—Å—è.

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
Integration tests –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–µ—Å—Ç–æ–≤—É—é –ë–î** (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ Spring Boot —Å –ø—Ä–æ—Ñ–∏–ª–µ–º `test`), –ø–æ—ç—Ç–æ–º—É –æ–Ω–∏ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é –ë–î.

## üÜò Troubleshooting

### "relation already exists"
```bash
docker compose down -v
docker compose up -d postgres
database\restore_database.bat
```

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ:
1. PostgreSQL –∑–∞–ø—É—â–µ–Ω: `docker ps | grep wmsdipl-postgres`
2. –ë–î —Å–æ–∑–¥–∞–Ω–∞: `docker exec wmsdipl-postgres psql -U wmsdipl -d wmsdipl -c "\dt"`
3. Flyway –æ—Ç–∫–ª—é—á–µ–Ω: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `application.yml`

### –ü–æ—Ç–µ—Ä—è–ª–∏ –¥–∞–Ω–Ω—ã–µ
–°–æ–∑–¥–∞–π—Ç–µ –±—ç–∫–∞–ø –ü–ï–†–ï–î –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏:
```bash
docker exec wmsdipl-postgres pg_dump -U wmsdipl -d wmsdipl > backup_$(date +%Y%m%d_%H%M%S).sql
```

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:
```bash
docker exec -i wmsdipl-postgres psql -U wmsdipl -d wmsdipl < backup_20260112_123456.sql
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- [database/README.md](database/README.md) - –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [PostgreSQL pg_dump](https://www.postgresql.org/docs/current/app-pgdump.html)
- [Docker PostgreSQL](https://hub.docker.com/_/postgres)

---

**–î–∞—Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞**: 2026-01-12  
**–ü—Ä–∏—á–∏–Ω–∞**: –£–ø—Ä–æ—â–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
