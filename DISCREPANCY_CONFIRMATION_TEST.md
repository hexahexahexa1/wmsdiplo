# Тестирование диалога подтверждения расхождений

## Что было исправлено

### 1. **Отображение расхождений в таблице сканов**
- ❌ **Было**: В колонке "Расхождение" показывалось `true` или `false`
- ✅ **Стало**: Показывается `✓ ОК` или `⚠ Есть расхождение`

### 2. **API для проверки расхождений**
- ✅ Добавлен endpoint `GET /api/tasks/{id}/has-discrepancies`
- ✅ Добавлен метод `TaskService.hasDiscrepancies(taskId)` - проверяет наличие сканов с флагом discrepancy=true

### 3. **Диалог подтверждения при завершении задания**
- ✅ При нажатии "Завершить" сначала проверяется наличие расхождений
- ✅ Если расхождения есть - показывается диалог с двумя вариантами:
  - **"Подтвердить завершение"** - завершает задание с расхождениями, приход может перейти в PENDING_RESOLUTION
  - **"Отменить и вернуться к приёмке"** - возвращает к форме сканирования для допринятия

## Как протестировать

### Подготовка

1. Запустить окружение:
```bash
start-environment.bat
start-core-api.bat
start-import-service.bat
start-desktop-client.bat
```

2. Войти в desktop-client (admin/password)

3. Импортировать тестовый приход (если еще нет):
```bash
copy test-receipt.xml import-service\input\
```

4. Создать задания для прихода:
   - Перейти в "Приходы"
   - Выбрать приход
   - Нажать "Подтвердить" (DRAFT → CONFIRMED)
   - Нажать "Начать приёмку" (CONFIRMED → IN_PROGRESS)
   - Создаются задания типа RECEIVING

### Тест 1: Завершение задания БЕЗ расхождений

1. Перейти во вкладку "Терминал"
2. Дважды кликнуть на любое задание NEW/ASSIGNED
3. Нажать "Назначить" (если NEW) → "Начать"
4. В форме "Факт" ввести данные **точно по документу**:
   - Паллета: PLT-001
   - Баркод: можно оставить пустым или ввести корректный
   - Количество: **точно ожидаемое** (например, если в документе 100, ввести 100)
5. Нажать "Отправить"
6. В таблице сканов должно появиться: `✓ ОК` в колонке "Расхождение"
7. Нажать "Завершить"
8. **Ожидаемый результат**: 
   - Диалог с расхождениями **НЕ** появляется
   - Задание сразу завершается
   - Статус меняется на COMPLETED

### Тест 2: Завершение задания С расхождением (недобор)

1. Открыть новое задание
2. Назначить → Начать
3. В форме "Факт" ввести данные с **недобором**:
   - Паллета: PLT-002
   - Баркод: можно оставить пустым
   - Количество: **меньше ожидаемого** (например, если ожидается 100, ввести 50)
4. Нажать "Отправить"
5. В таблице сканов должно появиться: `⚠ Есть расхождение` в колонке "Расхождение"
6. Нажать "Завершить"
7. **Ожидаемый результат**:
   - Появляется диалог с заголовком: **"⚠ Обнаружены расхождения"**
   - Текст объясняет, что можно подтвердить или отменить
   - Две кнопки: "Подтвердить завершение" и "Отменить и вернуться к приёмке"

### Тест 3: Подтверждение завершения с расхождением

1. Продолжить с Теста 2
2. В диалоге нажать **"Подтвердить завершение"**
3. **Ожидаемый результат**:
   - Диалог закрывается
   - Задание завершается (статус COMPLETED)
   - Сообщение "Задание завершено!" зеленым цветом
   - После завершения всех заданий прихода - приход переходит в PENDING_RESOLUTION

### Тест 4: Отмена завершения с расхождением

1. Открыть новое задание с расхождением (повторить Тест 2 шаги 1-6)
2. В диалоге нажать **"Отменить и вернуться к приёмке"**
3. **Ожидаемый результат**:
   - Диалог закрывается
   - Задание остается в статусе IN_PROGRESS
   - Сообщение "Завершение отменено" желтым цветом
   - Кнопка "Завершить" снова активна
   - Можно продолжить сканирование и допринять недостающее количество

### Тест 5: Допринятие после отмены

1. Продолжить с Теста 4
2. В форме "Факт" ввести **оставшееся количество**:
   - Паллета: PLT-002 (та же или другая)
   - Количество: **недостающее** (например, если ввели 50 из 100, теперь ввести 50)
3. Нажать "Отправить"
4. Проверить таблицу сканов:
   - Первый скан: `⚠ Есть расхождение` (недобор)
   - Второй скан: `✓ ОК` (довнесли)
5. Нажать "Завершить"
6. **Ожидаемый результат**:
   - Диалог **всё равно появляется** (т.к. первый скан имеет флаг discrepancy=true)
   - Нужно подтвердить завершение

### Тест 6: Завершение задания с избытком (OVER_QTY)

1. Открыть новое задание
2. Назначить → Начать
3. В форме "Факт" ввести **больше ожидаемого**:
   - Паллета: PLT-003
   - Количество: **больше ожидаемого** (например, если ожидается 100, ввести 150)
4. Нажать "Отправить"
5. В таблице сканов: `⚠ Есть расхождение`
6. Нажать "Завершить"
7. **Ожидаемый результат**:
   - Появляется диалог подтверждения расхождения

## Проверка логики определения расхождений

### Типы расхождений (создаются автоматически):

1. **UNDER_QTY** - недобор (принято меньше ожидаемого)
2. **OVER_QTY** - избыток (принято больше ожидаемого)
3. **BARCODE_MISMATCH** - несовпадение баркода
4. **SSCC_MISMATCH** - несовпадение SSCC

### Где проверить в коде:

- `ReceivingWorkflowService.recordScan()` - строки 196-227
- Создается `Discrepancy` в таблице `discrepancies`
- Устанавливается флаг `scan.discrepancy = true`

## Файлы изменений

### Backend (core-api)
- `TaskService.java` - добавлен метод `hasDiscrepancies()`
- `TaskController.java` - добавлен endpoint `GET /api/tasks/{id}/has-discrepancies`

### Frontend (desktop-client)
- `ApiClient.java` - добавлен метод `hasDiscrepancies(taskId)`
- `DesktopClientApplication.java`:
  - Изменено отображение колонки "Расхождение" в таблице сканов (строка ~1200)
  - Изменена логика кнопки "Завершить" с проверкой расхождений (строка ~1053)
  - Добавлен метод `showDiscrepancyConfirmationDialog()` (строка ~1562)

## Ожидаемое поведение

✅ **При завершении задания БЕЗ расхождений**: задание завершается сразу
✅ **При завершении задания С расхождениями**: показывается диалог с выбором
✅ **При подтверждении**: задание завершается, расхождения фиксируются
✅ **При отмене**: возвращается к форме, можно допринять
✅ **Отображение в таблице**: `✓ ОК` или `⚠ Есть расхождение` вместо true/false

## Что дальше

После завершения всех заданий с расхождениями:
- Приход переходит в статус **PENDING_RESOLUTION**
- Нужно разрешить расхождения через API:
  - `GET /api/discrepancies?receiptId={id}` - получить список
  - `POST /api/discrepancies/{id}/resolve` - разрешить каждое
  - `POST /api/receipts/{id}/complete-receiving` - повторно завершить приёмку
- После разрешения всех расхождений: **PENDING_RESOLUTION → ACCEPTED**
